{% extends "lotto/base.html" %} 
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
    <p class="lead">ë¡œë˜ íŒë§¤ ì‹¤ì  í™•ì¸ ë° ìƒˆë¡œìš´ íšŒì°¨ ì¶”ì²¨ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

    {% comment %} Viewì—ì„œ ì „ë‹¬ëœ ë©”ì‹œì§€ (ì¶”ì²¨ ì„±ê³µ, ì‹¤ì  ì§‘ê³„ ì™„ë£Œ ë“±) í‘œì‹œ {% endcomment %}
    

    <div class="row mt-4">
        
        <div class="col-md-6 mb-4">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5>ğŸ² í˜„ì¬ íšŒì°¨ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    {% if latest_round %}
                        {% with is_finalized=latest_round.num1 %}
                            <p>ê°€ì¥ ìµœê·¼ ìƒì„±ëœ íšŒì°¨: **ì œ {{ latest_round.round }} íšŒì°¨**</p>
                            
                            <p><strong>í˜„ì¬ íŒë§¤ ì¥ìˆ˜:</strong> <span class="badge bg-primary fs-6">{{ current_round_sales_count|default:"0" }} ì¥</span></p>
                            
                            {% if is_finalized %}
                                <div class="alert alert-success mt-3">
                                    <h6>âœ… {{ latest_round.round }}íšŒì°¨ ì¶”ì²¨ ì™„ë£Œ</h6>
                                    **ë‹¹ì²¨ ë²ˆí˜¸:** {% for num in latest_round.get_winning_numbers %}
                                        <span class="badge bg-danger me-1">{{ num }}</span>
                                    {% endfor %}
                                    <span class="badge bg-warning text-dark ms-2">ë³´ë„ˆìŠ¤: {{ latest_round.bonus_number }}</span>
                                    
                                    {% comment %} ì‹¤ì  ì§‘ê³„ ì™„ë£Œ ìƒíƒœ í‘œì‹œ (finalize_lotto_roundì— í†µí•©ë¨) {% endcomment %}
                                    {% if latest_round.salesperformance %}
                                        <p class="text-success mt-2 mb-0">ğŸ‘‰ **íŒë§¤ ì‹¤ì  ì§‘ê³„ ì™„ë£Œ** (ì´ íŒë§¤: {{ latest_round.salesperformance.total_sales }}ì¥)</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning mt-3">
                                    <h6>âš ï¸ {{ latest_round.round }}íšŒì°¨ íŒë§¤ ì¤‘ (ì¶”ì²¨ ëŒ€ê¸°)</h6>
                                    
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <div class="alert alert-danger">
                            ì•„ì§ ìƒì„±ëœ ë¡œë˜ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ 1íšŒì°¨ë¥¼ ì‹œì‘í•´ ì£¼ì„¸ìš”.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5>â¡ï¸ ë¡œë˜ ì‹œìŠ¤í…œ ê´€ë¦¬</h5>
                </div>
                <div class="card-body">
                    
                    {% comment %}
                    ë‹¨ìˆœí™”ëœ ê´€ë¦¬ íë¦„:
                    1. num1ì´ nullì´ë©´ (íŒë§¤ ì¤‘): ì¶”ì²¨ ë° ìë™ ì§‘ê³„ ë²„íŠ¼ í‘œì‹œ (finalize_lotto_round)
                    2. num1ì´ nullì´ ì•„ë‹ˆë©´ (ì¶”ì²¨ ì™„ë£Œ): ë‹¤ìŒ íšŒì°¨ ìƒì„± ë²„íŠ¼ í‘œì‹œ (create_next_round)
                    {% endcomment %}

                    {% if latest_round and not latest_round.num1 %}
                        {# 1. ì¶”ì²¨ ë° ì‹¤ì  ì§‘ê³„ (í˜„ì¬ íšŒì°¨ íŒë§¤ ì¤‘) #}
                        <h4 class="text-danger">1. {{ latest_round.round }}íšŒì°¨ ì¶”ì²¨ ë° ìë™ ì§‘ê³„</h4>
                        <p class="text-muted">íŒë§¤ë¥¼ ë§ˆê°í•˜ê³  **ë‹¹ì²¨ ë²ˆí˜¸ í™•ì •**ê³¼ **íŒë§¤ ì‹¤ì  ì§‘ê³„**ë¥¼ **í•œ ë²ˆì—** ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
                        <form method="post" action="{% url 'finalize_lotto_round' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-lg w-100">
                                <i class="fas fa-dice"></i> {{ latest_round.round }} íšŒì°¨ **ì¶”ì²¨ ë° ìë™ ì§‘ê³„**
                            </button>
                        </form>

                    {% else %}
                        {# 2. ë‹¤ìŒ íšŒì°¨ ìƒì„± (ì¶”ì²¨ ì™„ë£Œ í›„ í˜¹ì€ ìµœì´ˆ ì‹œì‘) #}
                        <h4 class="text-primary">1. ë‹¤ìŒ íšŒì°¨ ìƒì„± ({{ next_round_number }}íšŒì°¨)</h4>
                        <p class="text-muted">ìƒˆë¡œìš´ íšŒì°¨(ì œ **{{ next_round_number }} íšŒì°¨**)ë¥¼ ìƒì„±í•˜ì—¬ ë¡œë˜ **êµ¬ë§¤ë¥¼ ì‹œì‘**í•©ë‹ˆë‹¤.</p>
                        <form method="post" action="{% url 'create_next_round' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-plus-circle"></i> ì œ {{ next_round_number }} íšŒì°¨ **ìƒì„± ë° íŒë§¤ ì‹œì‘**
                            </button>
                        </form>
                    {% endif %}

                </div>
            </div>
        </div>
        
    </div>

    <hr class="my-5">
    
    <div class="card border-secondary mb-5">
        <div class="card-header bg-secondary text-white">
            <h5>ğŸ“‹ ì „ì²´ íšŒì°¨ íŒë§¤ ì‹¤ì  ëª©ë¡</h5>
        </div>
        <div class="card-body">
            {% if all_sales_performance %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>íšŒì°¨</th>
                            <th>ì¶”ì²¨ì¼</th>
                            <th>ì´ íŒë§¤ (ì¥)</th>
                            <th>ì´ ë‹¹ì²¨ì</th>
                            <th class="text-success">1ë“± ë‹¹ì²¨</th>
                            <th class="text-info">2ë“± ë‹¹ì²¨</th>
                            <th class="text-warning">3ë“± ë‹¹ì²¨</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sales in all_sales_performance %}
                        <tr>
                            <td><strong>ì œ {{ sales.round.round }} íšŒì°¨</strong></td>
                            <td>{{ sales.round.draw_date|date:"Y-m-d" }}</td>
                            <td>{{ sales.total_sales|default:"0" }}</td>
                            <td>{{ sales.total_winners|default:"0" }}</td>
                            <td class="text-success">{{ sales.rank1_winners|default:"0" }}</td>
                            <td class="text-info">{{ sales.rank2_winners|default:"0" }}</td>
                            <td class="text-warning">{{ sales.rank3_winners|default:"0" }}</td>
                            <td><a href="{% url 'admin:lotto_salesperformance_change' sales.pk %}" class="btn btn-sm btn-outline-secondary">ìƒì„¸</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <small class="text-muted">ì „ì²´ íŒë§¤ ì‹¤ì  ë° ìƒì„¸ ì •ë³´ëŠ” Django ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
            {% else %}
                <div class="alert alert-warning mb-0">ì•„ì§ ì§‘ê³„ëœ íŒë§¤ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
        </div>
    </div>
    </div>
{% endblock content %}